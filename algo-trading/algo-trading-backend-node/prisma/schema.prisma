// ============================================================
// PRISMA SCHEMA — ALGO TRADING PLATFORM (SQLite)
// ============================================================
// SQLite version: enums → String, Json → String (parsed in app)
// All monetary values stored as Float
// Timestamps use DateTime with @default(now())
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── USER & AUTH ────────────────────────────────────────────

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  fullName      String
  role          String   @default("USER") // USER | ADMIN
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  wallet        Wallet?
  apiKeys       BrokerApiKey[]
  strategies    Strategy[]
  orders        Order[]
  positions     Position[]
  trades        Trade[]
  riskState     RiskState?
  auditLogs     AuditLog[]
  backtests     Backtest[]

  @@index([email])
}

model BrokerApiKey {
  id                 String    @id @default(uuid())
  userId             String
  broker             String    @default("angelone") // angelone, zerodha
  apiKeyEncrypted    String
  apiSecretEncrypted String
  accessToken        String?
  refreshToken       String?
  feedToken          String?
  tokenExpiresAt     DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, broker])
  @@index([userId])
}

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  balance         Float    @default(100000)
  usedMargin      Float    @default(0)
  availableMargin Float    @default(100000)
  realizedPnl     Float    @default(0)
  unrealizedPnl   Float    @default(0)
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── STRATEGY ───────────────────────────────────────────────

model Strategy {
  id                String   @id @default(uuid())
  userId            String
  name              String
  description       String?
  symbol            String
  symbolToken       String?  // Angel One symbol token
  exchange          String   @default("NSE")
  timeframe         String   @default("FIVE_MINUTES")
  strategyType      String   // MA_CROSSOVER, RSI, CUSTOM
  status            String   @default("CREATED") // CREATED, RUNNING, STOPPED, ERROR
  parameters        String   @default("{}") // JSON string
  quantity          Int      @default(1)
  maxLossPerTrade   Float?
  stopLossPercent   Float?
  takeProfitPercent Float?
  maxTradesPerDay   Int      @default(5)
  tradingStartTime  String?  // "09:15"
  tradingEndTime    String?  // "15:15"
  squareOffTime     String?  // "15:20"
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    Order[]
  positions Position[]
  trades    Trade[]
  backtests Backtest[]

  @@index([userId])
  @@index([status])
  @@index([symbol])
}

// ─── ORDERS ─────────────────────────────────────────────────

model Order {
  id              String    @id @default(uuid())
  userId          String
  strategyId      String?
  brokerOrderId   String?
  symbol          String
  exchange        String    @default("NSE")
  side            String    // BUY | SELL
  quantity        Int
  orderType       String    @default("MARKET")
  productType     String    @default("MIS")
  limitPrice      Float?
  triggerPrice    Float?
  filledPrice     Float?
  filledQuantity  Int?
  status          String    @default("CREATED")
  rejectedReason  String?
  placedAt        DateTime?
  filledAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([status])
  @@index([createdAt])
  @@index([brokerOrderId])
}

// ─── POSITIONS ──────────────────────────────────────────────

model Position {
  id            String    @id @default(uuid())
  userId        String
  strategyId    String?
  symbol        String
  exchange      String    @default("NSE")
  side          String    // LONG | SHORT
  quantity      Int
  entryPrice    Float
  currentPrice  Float
  exitPrice     Float?
  stopLoss      Float?    // mandatory stop loss price
  takeProfit    Float?    // mandatory take profit price
  unrealizedPnl Float     @default(0)
  realizedPnl   Float     @default(0)
  status        String    @default("OPEN")
  entryOrderId  String?
  exitOrderId   String?
  openedAt      DateTime  @default(now())
  closedAt      DateTime?
  updatedAt     DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([status])
  @@index([symbol])
}

// ─── TRADES (Closed P&L Records) ────────────────────────────

model Trade {
  id         String   @id @default(uuid())
  userId     String
  strategyId String?
  symbol     String
  exchange   String   @default("NSE")
  side       String   // BUY | SELL
  quantity   Int
  entryPrice Float
  exitPrice  Float
  pnl        Float
  pnlPercent Float
  entryTime  DateTime
  exitTime   DateTime
  duration   Int
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([createdAt])
  @@index([symbol])
}

// ─── CANDLES (Market Data) ──────────────────────────────────

model Candle {
  id        String   @id @default(uuid())
  symbol    String
  exchange  String   @default("NSE")
  timeframe String
  timestamp DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([symbol, timeframe, timestamp])
  @@index([symbol, timeframe, timestamp])
  @@index([timestamp])
}

// ─── RISK STATE ─────────────────────────────────────────────

model RiskState {
  id                 String   @id @default(uuid())
  userId             String   @unique
  dailyLoss          Float    @default(0)
  dailyTradeCount    Int      @default(0)
  consecutiveLosses  Int      @default(0)
  isLocked           Boolean  @default(false)
  lockReason         String?
  tradingDate        DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, tradingDate])
}

// ─── BACKTESTING ────────────────────────────────────────────

model Backtest {
  id              String   @id @default(uuid())
  userId          String
  strategyId      String
  symbol          String
  startDate       DateTime
  endDate         DateTime
  initialCapital  Float
  finalCapital    Float?
  totalTrades     Int?
  winningTrades   Int?
  losingTrades    Int?
  winRate         Float?
  totalPnl        Float?
  maxDrawdown     Float?
  maxDrawdownPct  Float?
  sharpeRatio     Float?
  sortinoRatio    Float?
  profitFactor    Float?
  avgWin          Float?
  avgLoss         Float?
  equityCurve     String?  // JSON string
  trades          String?  // JSON string
  status          String   @default("running")
  error           String?
  createdAt       DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([strategyId])
}

// ─── AUDIT LOG ──────────────────────────────────────────────

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  event     String
  severity  String   @default("INFO")
  message   String
  metadata  String?  // JSON string
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([event])
  @@index([severity])
  @@index([createdAt])
}
