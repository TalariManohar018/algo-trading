// ============================================================
// PRISMA SCHEMA — ALGO TRADING PLATFORM
// ============================================================
// Design decisions:
// - All monetary values stored as Float (Decimal in production with @db.Decimal(18,4))
// - Timestamps use DateTime with @default(now())
// - Soft deletes via isActive flags where needed
// - Indexes on frequently queried fields (userId, symbol, status, timestamps)
// - Composite indexes for time-series queries
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USER & AUTH ────────────────────────────────────────────

enum Role {
  USER
  ADMIN
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  fullName      String
  role          Role     @default(USER)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  wallet        Wallet?
  apiKeys       BrokerApiKey[]
  strategies    Strategy[]
  orders        Order[]
  positions     Position[]
  trades        Trade[]
  riskState     RiskState?
  auditLogs     AuditLog[]
  backtests     Backtest[]

  @@index([email])
}

model BrokerApiKey {
  id              String   @id @default(uuid())
  userId          String
  broker          String   @default("zerodha") // zerodha, angelone, etc.
  apiKeyEncrypted String   // AES-256 encrypted
  apiSecretEncrypted String
  accessToken     String?  // Session token (refreshed daily)
  tokenExpiresAt  DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, broker])
  @@index([userId])
}

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  balance         Float    @default(100000) // ₹1,00,000 paper trading default
  usedMargin      Float    @default(0)
  availableMargin Float    @default(100000)
  realizedPnl     Float    @default(0)
  unrealizedPnl   Float    @default(0)
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── STRATEGY ───────────────────────────────────────────────

enum StrategyStatus {
  CREATED
  RUNNING
  STOPPED
  ERROR
}

enum TimeFrame {
  ONE_MINUTE
  FIVE_MINUTES
  FIFTEEN_MINUTES
  THIRTY_MINUTES
  ONE_HOUR
  ONE_DAY
}

model Strategy {
  id              String         @id @default(uuid())
  userId          String
  name            String
  description     String?
  symbol          String         // e.g., "NIFTY", "RELIANCE"
  exchange        String         @default("NSE")
  timeframe       TimeFrame      @default(FIVE_MINUTES)
  strategyType    String         // "MA_CROSSOVER", "RSI", "CUSTOM"
  status          StrategyStatus @default(CREATED)

  // Strategy parameters stored as JSON for flexibility
  parameters      Json           // { fastPeriod: 9, slowPeriod: 21, ... }

  // Risk per strategy
  quantity        Int            @default(1)
  maxLossPerTrade Float?
  stopLossPercent Float?
  takeProfitPercent Float?
  maxTradesPerDay Int            @default(5)

  // Trading window
  tradingStartTime String?       // "09:15"
  tradingEndTime   String?       // "15:15"
  squareOffTime    String?       // "15:20"

  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders   Order[]
  positions Position[]
  trades   Trade[]
  backtests Backtest[]

  @@index([userId])
  @@index([status])
  @@index([symbol])
}

// ─── ORDERS ─────────────────────────────────────────────────

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
  SL       // Stop-loss
  SL_M     // Stop-loss market
}

enum OrderStatus {
  CREATED
  PENDING
  PLACED
  FILLED
  PARTIALLY_FILLED
  CANCELLED
  REJECTED
}

enum ProductType {
  MIS   // Intraday
  NRML  // Carry forward
  CNC   // Cash & carry
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  strategyId      String?
  brokerOrderId   String?     // ID from Zerodha/broker
  symbol          String
  exchange        String      @default("NSE")
  side            OrderSide
  quantity        Int
  orderType       OrderType   @default(MARKET)
  productType     ProductType @default(MIS)
  limitPrice      Float?
  triggerPrice    Float?      // For SL orders
  filledPrice     Float?
  filledQuantity  Int?
  status          OrderStatus @default(CREATED)
  rejectedReason  String?
  placedAt        DateTime?
  filledAt        DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([status])
  @@index([createdAt])
  @@index([brokerOrderId])
}

// ─── POSITIONS ──────────────────────────────────────────────

enum PositionSide {
  LONG
  SHORT
}

enum PositionStatus {
  OPEN
  CLOSED
}

model Position {
  id              String         @id @default(uuid())
  userId          String
  strategyId      String?
  symbol          String
  exchange        String         @default("NSE")
  side            PositionSide
  quantity        Int
  entryPrice      Float
  currentPrice    Float
  exitPrice       Float?
  unrealizedPnl   Float          @default(0)
  realizedPnl     Float          @default(0)
  status          PositionStatus @default(OPEN)
  entryOrderId    String?
  exitOrderId     String?
  openedAt        DateTime       @default(now())
  closedAt        DateTime?
  updatedAt       DateTime       @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([status])
  @@index([symbol])
}

// ─── TRADES (Closed P&L Records) ────────────────────────────

model Trade {
  id              String    @id @default(uuid())
  userId          String
  strategyId      String?
  symbol          String
  exchange        String    @default("NSE")
  side            OrderSide
  quantity        Int
  entryPrice      Float
  exitPrice       Float
  pnl             Float
  pnlPercent      Float
  entryTime       DateTime
  exitTime        DateTime
  duration        Int       // seconds
  createdAt       DateTime  @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([strategyId])
  @@index([createdAt])
  @@index([symbol])
}

// ─── CANDLES (Market Data) ──────────────────────────────────

model Candle {
  id        String   @id @default(uuid())
  symbol    String
  exchange  String   @default("NSE")
  timeframe TimeFrame
  timestamp DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    BigInt
  createdAt DateTime @default(now())

  @@unique([symbol, timeframe, timestamp])
  @@index([symbol, timeframe, timestamp])
  @@index([timestamp])
}

// ─── RISK STATE ─────────────────────────────────────────────

model RiskState {
  id              String   @id @default(uuid())
  userId          String   @unique
  dailyLoss       Float    @default(0)
  dailyTradeCount Int      @default(0)
  isLocked        Boolean  @default(false)
  lockReason      String?
  tradingDate     DateTime @default(now()) @db.Date
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, tradingDate])
}

// ─── BACKTESTING ────────────────────────────────────────────

model Backtest {
  id              String   @id @default(uuid())
  userId          String
  strategyId      String
  symbol          String
  startDate       DateTime
  endDate         DateTime
  initialCapital  Float
  finalCapital    Float?
  totalTrades     Int?
  winningTrades   Int?
  losingTrades    Int?
  winRate         Float?
  totalPnl        Float?
  maxDrawdown     Float?
  maxDrawdownPct  Float?
  sharpeRatio     Float?
  sortinoRatio    Float?
  profitFactor    Float?
  avgWin          Float?
  avgLoss         Float?
  // Equity curve stored as JSON array of { timestamp, equity }
  equityCurve     Json?
  trades          Json?     // Array of individual backtest trades
  status          String    @default("running") // running, completed, failed
  error           String?
  createdAt       DateTime  @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([strategyId])
}

// ─── AUDIT LOG ──────────────────────────────────────────────

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model AuditLog {
  id        String        @id @default(uuid())
  userId    String
  event     String        // "ORDER_PLACED", "RISK_BREACH", "ENGINE_START", etc.
  severity  AuditSeverity @default(INFO)
  message   String
  metadata  Json?
  createdAt DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([event])
  @@index([severity])
  @@index([createdAt])
}
